<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>R√ºckmeldung geben</title>
  <style>
    body {
      background-color: #1e1e2f;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s; /* Synchronisation */
    }
    body.light {
      background-color: #f5f5f5;
      color: #111;
    }

    h1 {
      text-align: center;
    }

    .person {
      background: #2e2e3f;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: background 0.2s, background-color 0.3s; /* Synchronisation */
    }
    body.light .person {
        background: #fff;
        border: 1px solid #ccc;
    }

    .person:hover {
      background: #3a3a4f;
    }
    body.light .person:hover {
        background: #e0e0e0;
    }

    .person img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
    }

    .feedback-box {
      margin-top: 15px;
      background: #2e2e3f;
      padding: 15px;
      border-radius: 8px;
      transition: background-color 0.3s; /* Synchronisation */
    }
    body.light .feedback-box {
        background: #fff;
        border: 1px solid #ccc;
    }

    textarea {
      width: 100%;
      height: 80px;
      resize: vertical;
      background: #1e1e2f; /* Dark mode default */
      color: white;
      border: 1px solid #555;
      border-radius: 6px;
      padding: 10px;
      font-size: 14px;
      box-sizing: border-box;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s; /* Synchronisation */
    }
    body.light textarea {
      background: #fff; /* Light mode */
      color: #111;
      border: 1px solid #ccc;
    }

    button {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #5865F2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #4752c4;
    }

    /* Konsistenter Klassenname */
    .zurueck-btn {
      margin-top: 20px;
      background: grey;
    }
    .zurueck-btn:hover {
        background-color: #555;
    }

    .feedbacks {
      margin-top: 10px;
      font-style: italic;
      font-size: 14px;
      color: #ccc;
    }
    body.light .feedbacks { /* Lesbarkeit im Light Mode */
        color: #555;
    }
  </style>
</head>
<body>

<h1>R√ºckmeldung geben</h1>
<div id="personen"></div>

<div class="feedback-box" style="display:none;" id="feedbackSection">
  <div id="ausgewaehltName" style="font-weight: bold;"></div>
  <div class="feedbacks" id="bisherigeFeedbacks">Keine Feedbacks.</div>
  <textarea id="feedbackText" placeholder="Dein Feedback hier eingeben..."></textarea>
  <button onclick="absenden()">Absenden</button>
</div>

<button class="zurueck-btn" onclick="window.location.href='Webseite.html'">Zur√ºck</button>

<script>
const apiUrl = "https://food-feedback-bot.onrender.com/rolle/1340398700136104069";
const webhookUrl = "https://discord.com/api/webhooks/1392150424097915042/RQoNPfTIxyP7XUNJdOOHptgWWaKSDl6C8jh13puHQ3xcX7aWuDjaG5wHoE8PtV7c8QLa";

let ausgewaehlt = null;

fetch(apiUrl)
  .then(res => res.json())
  .then(data => {
    const container = document.getElementById("personen");
    if (data.length === 0) {
        container.innerHTML = "<p>Keine Mitglieder gefunden.</p>";
        return;
    }
    data.forEach(person => {
      const div = document.createElement("div");
      div.className = "person";
      // Fallback f√ºr Avatar-Bilder
      const avatarSrc = person.avatar ? `https://cdn.discordapp.com/avatars/${person.id}/${person.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png';
      div.innerHTML = `<img src="${avatarSrc}" alt="Profilbild"><strong>${person.name}</strong>`;
      div.onclick = () => auswahl(person);
      container.appendChild(div);
    });
  })
  .catch(err => {
    document.getElementById("personen").innerHTML = "<p>Fehler beim Laden der Mitglieder.</p>";
    console.error(err);
  });

function auswahl(person) {
  ausgewaehlt = person;
  document.getElementById("feedbackSection").style.display = "block";
  document.getElementById("ausgewaehltName").textContent = "Feedback an: " + person.name;

  const alle = JSON.parse(localStorage.getItem("feedbacks") || "{}");
  const liste = alle[person.id] || [];

  const feedbackDiv = document.getElementById("bisherigeFeedbacks");
  if (liste.length === 0) {
    feedbackDiv.textContent = "Keine Feedbacks.";
  } else {
    feedbackDiv.innerHTML = liste.map(text => "‚Ä¢ " + text).join("<br>");
  }
}

function absenden() {
  const text = document.getElementById("feedbackText").value.trim();
  if (!ausgewaehlt || !text) return alert("Bitte w√§hle eine Person und gib Feedback ein.");

  const alle = JSON.parse(localStorage.getItem("feedbacks") || "{}");
  if (!alle[ausgewaehlt.id]) alle[ausgewaehlt.id] = [];
  alle[ausgewaehlt.id].push(text);
  localStorage.setItem("feedbacks", JSON.stringify(alle));

  const user = JSON.parse(localStorage.getItem("discordUser") || "{}");
  const sender = user.global_name || user.username || "Unbekannt";

  fetch(webhookUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      content:
        `üì¨ **Feedback eingegangen**\n` +
        `üë§ Von: **${sender}**\n` +
        `üéØ An: **${ausgewaehlt.name}**\n` +
        `üí¨ ${text}`
    })
  }).then(res => {
    if (res.ok) {
        alert("Feedback gesendet.");
        document.getElementById("feedbackText").value = "";
        auswahl(ausgewaehlt); // Feedbacks neu laden
    } else {
        alert("Fehler beim Senden des Feedbacks an Discord.");
        console.error("Webhook-Fehler:", res);
    }
  }).catch(err => {
    alert("Netzwerkfehler beim Senden des Feedbacks.");
    console.error("Netzwerkfehler:", err);
  });
}

// Thema beim Laden anwenden
const theme = localStorage.getItem("theme");
if (theme === "light") {
    document.body.classList.add("light");
}
</script>

</body>
</html>

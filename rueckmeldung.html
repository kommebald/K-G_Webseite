<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>RÃ¼ckmeldung geben</title>
  <style>
    body {
      background-color: #1e1e2f;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
    }

    .person {
      background: #2e2e3f;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .person:hover {
      background: #3a3a4f;
    }

    .person img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
    }

    .feedback-box {
      margin-top: 15px;
      background: #2e2e3f;
      padding: 15px;
      border-radius: 8px;
    }

    textarea {
      width: 100%;
      height: 80px;
      resize: vertical;
      background: #1e1e2f;
      color: white;
      border: 1px solid #555;
      border-radius: 6px;
      padding: 10px;
      font-size: 14px;
    }

    button {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #5865F2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .zurueck {
      margin-top: 20px;
      background: gray;
    }

    .feedbacks {
      margin-top: 10px;
      font-style: italic;
      font-size: 14px;
      color: #ccc;
    }
  </style>
</head>
<body>

<h1>RÃ¼ckmeldung geben</h1>
<div id="personen"></div>

<div class="feedback-box" style="display:none;" id="feedbackSection">
  <div id="ausgewaehltName" style="font-weight: bold;"></div>
  <div class="feedbacks" id="bisherigeFeedbacks">Keine Feedbacks.</div>
  <textarea id="feedbackText" placeholder="Dein Feedback hier eingeben..."></textarea>
  <button onclick="absenden()">Absenden</button>
</div>

<button class="zurueck" onclick="window.location.href='webseite.html'">ZurÃ¼ck</button>

<script>
const apiUrl = "https://food-feedback-bot.onrender.com/rolle/1340398700136104069";
const webhookUrl = "https://discord.com/api/webhooks/1392150424097915042/RQoNPfTIxyP7XUNJdOOHptgWWaKSDl6C8jh13puHQ3xcX7aWuDjaG5wHoE8PtV7c8QLa";

let ausgewaehlt = null;

fetch(apiUrl)
  .then(res => res.json())
  .then(data => {
    const container = document.getElementById("personen");
    data.forEach(person => {
      const div = document.createElement("div");
      div.className = "person";
      div.innerHTML = `<img src="${person.avatar}" alt="Profilbild"><strong>${person.name}</strong>`;
      div.onclick = () => auswahl(person);
      container.appendChild(div);
    });
  })
  .catch(err => {
    document.getElementById("personen").innerHTML = "<p>Fehler beim Laden der Mitglieder.</p>";
    console.error(err);
  });

function auswahl(person) {
  ausgewaehlt = person;
  document.getElementById("feedbackSection").style.display = "block";
  document.getElementById("ausgewaehltName").textContent = "Feedback an: " + person.name;

  // Lade vorhandene Feedbacks aus localStorage
  const alle = JSON.parse(localStorage.getItem("feedbacks") || "{}");
  const liste = alle[person.id] || [];

  const feedbackDiv = document.getElementById("bisherigeFeedbacks");
  if (liste.length === 0) {
    feedbackDiv.textContent = "Keine Feedbacks.";
  } else {
    feedbackDiv.innerHTML = liste.map(text => "â€¢ " + text).join("<br>");
  }
}

function absenden() {
  const text = document.getElementById("feedbackText").value.trim();
  if (!ausgewaehlt || !text) return alert("Bitte wÃ¤hle eine Person und gib Feedback ein.");

  // Speichern im localStorage
  const alle = JSON.parse(localStorage.getItem("feedbacks") || "{}");
  if (!alle[ausgewaehlt.id]) alle[ausgewaehlt.id] = [];
  alle[ausgewaehlt.id].push(text);
  localStorage.setItem("feedbacks", JSON.stringify(alle));

  // Benutzername fÃ¼r die Nachricht
  const user = JSON.parse(localStorage.getItem("discordUser") || "{}");
  const sender = user.global_name || user.username || "Unbekannt";

  // Webhook senden
  fetch(webhookUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      content:
        `ðŸ“¬ **Feedback eingegangen**\n` +
        `ðŸ‘¤ Von: **${sender}**\n` +
        `ðŸŽ¯ An: **${ausgewaehlt.name}**\n` +
        `ðŸ’¬ ${text}`
    })
  });

  alert("Feedback gesendet.");
  document.getElementById("feedbackText").value = "";
  auswahl(ausgewaehlt); // neu laden
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√ºckmeldung</title>
  <style>
    body {
      background-color: #1e1e2f;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
    body.light {
      background-color: #f5f5f5;
      color: #111;
    }
    h1 {
      text-align: center;
    }
    .mitglied {
      background-color: #2e2e3f;
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      cursor: pointer;
    }
    body.light .mitglied {
      background-color: #fff;
      border: 1px solid #ccc;
    }
    .feedback-liste {
      margin-top: 8px;
      font-size: 0.9em;
    }
    .feedback-item {
      background-color: #444;
      padding: 6px;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    body.light .feedback-item {
      background-color: #eee;
      color: #111;
    }
    textarea {
      width: 100%;
      max-width: 500px;
      height: 100px;
      margin-top: 10px;
      padding: 10px;
      font-size: 1em;
      border-radius: 5px;
      background-color: #333;
      color: white;
      border: 1px solid #555;
    }
    body.light textarea {
      background-color: white;
      color: black;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #5865F2;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }
    body.light button {
      background-color: #0078d7;
    }
  </style>
</head>
<body>
<h1>R√ºckmeldung geben</h1>
<div id="liste">Lade Mitglieder...</div>
<div id="feedback-bereich" style="display:none">
  <h2 id="ziel-nutzer"></h2>
  <textarea id="feedback" placeholder="Dein Feedback..."></textarea>
  <br>
  <button onclick="sendeFeedback()">Abschicken</button>
</div>
<script>
const webhook = "https://discord.com/api/webhooks/YOUR_WEBHOOK_URL";
const roleId = "1340398700136104069";
const serverBaseUrl = "https://kommebald.replit.app"; // üëà Replit-URL
let zielID = "";

function ladeFeedbacks() {
  return JSON.parse(localStorage.getItem("feedbacks")) || {};
}

function zeigeMitglieder(mitglieder) {
  const feedbacks = ladeFeedbacks();
  document.getElementById("liste").innerHTML = "";
  mitglieder.forEach(m => {
    const div = document.createElement("div");
    div.className = "mitglied";
    const name = document.createElement("div");
    name.textContent = m.name;
    name.style.fontWeight = "bold";

    const feedbackDiv = document.createElement("div");
    feedbackDiv.className = "feedback-liste";
    const eintraege = feedbacks[m.id] || [];
    eintraege.forEach(e => {
      const f = document.createElement("div");
      f.className = "feedback-item";
      f.textContent = `"${e.text}" ‚Äì ${e.sender}`;
      feedbackDiv.appendChild(f);
    });

    div.onclick = () => {
      zielID = m.id;
      document.getElementById("ziel-nutzer").textContent = `Feedback f√ºr ${m.name}`;
      document.getElementById("feedback-bereich").style.display = "block";
    };

    div.appendChild(name);
    div.appendChild(feedbackDiv);
    document.getElementById("liste").appendChild(div);
  });
}

function sendeFeedback() {
  const text = document.getElementById("feedback").value.trim();
  const sender = localStorage.getItem("discordName") || "Unbekannt";
  if (!text) return alert("Bitte Feedback eingeben.");

  const all = ladeFeedbacks();
  all[zielID] = all[zielID] || [];
  all[zielID].push({ sender, text });
  localStorage.setItem("feedbacks", JSON.stringify(all));

  const data = {
    content: `üìù **Feedback von ${sender}** f√ºr <@${zielID}>:\n${text}`
  };
  fetch(webhook, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  }).then(r => {
    if (r.ok) {
      alert("Feedback gesendet!");
      document.getElementById("feedback").value = "";
      document.getElementById("feedback-bereich").style.display = "none";
      holeMitglieder();
    } else {
      alert("Fehler beim Senden.");
    }
  });
}

function holeMitglieder() {
  fetch(`${serverBaseUrl}/rolle/${roleId}`)
    .then(res => res.json())
    .then(zeigeMitglieder)
    .catch(() => {
      document.getElementById("liste").textContent = "Fehler beim Laden der Mitglieder.";
    });
}

const theme = localStorage.getItem("theme");
if (theme === "light") document.body.classList.add("light");
holeMitglieder();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>R√ºckmeldung geben</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background-color: #1e1e2f;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: right;
    }
    .mitglied {
      background: #2e2e3f;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .mitglied img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }
    .feedback-container {
      margin-top: 10px;
      background: #1a1a2f;
      padding: 10px;
      border-radius: 6px;
    }
    .feedback-container textarea {
      width: 100%;
      padding: 10px;
      border-radius: 4px;
      border: none;
      background: #2a2a3f;
      color: white;
      resize: vertical;
    }
    .feedback-container button {
      margin-top: 10px;
      background: #5865F2;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    .feedback-list {
      margin-bottom: 10px;
      padding-left: 10px;
      border-left: 2px solid #444;
    }
  </style>
</head>
<body>
  <h1>R√ºckmeldung geben</h1>
  <div id="liste"></div>
  <button onclick="window.location.href='Webseite.html'">Zur√ºck</button>

  <script>
    const user = JSON.parse(localStorage.getItem("discordUser"));
    const WEBHOOK_URL = "https://discord.com/api/webhooks/1392150424097915042/RQoNPfTIxyP7XUNJdOOHptgWWaKSDl6C8jh13puHQ3xcX7aWuDjaG5wHoE8PtV7c8QLa";
    const API_URL = "https://food-feedback-bot.onrender.com";

    async function ladeMitglieder() {
      try {
        const res = await fetch(`${API_URL}/rolle/1340398700136104069`);
        const daten = await res.json();
        const container = document.getElementById("liste");
        container.innerHTML = "";

        daten.forEach(m => {
          const div = document.createElement("div");
          div.className = "mitglied";
          div.innerHTML = `
            <span><img src="https://cdn.discordapp.com/avatars/${m.id}/${m.avatar}.png" onerror="this.src='https://cdn.discordapp.com/embed/avatars/0.png'"> ${m.display_name} (${m.username})</span>
          `;

          div.addEventListener("click", () => zeigeFeedbackFeld(div, m));
          container.appendChild(div);
        });
      } catch (e) {
        document.getElementById("liste").innerHTML = "<p>Fehler beim Laden der Mitglieder.</p>";
      }
    }

    function zeigeFeedbackFeld(parent, userInfo) {
      if (parent.querySelector(".feedback-container")) return;

      const wrapper = document.createElement("div");
      wrapper.className = "feedback-container";

      const feedbackList = document.createElement("div");
      feedbackList.className = "feedback-list";
      feedbackList.innerHTML = ladeFeedback(userInfo.id)
        .map(msg => `<div>‚Ä¢ ${msg}</div>`).join("") || "<em>Keine bisherigen R√ºckmeldungen.</em>";

      const textarea = document.createElement("textarea");
      textarea.placeholder = "Dein Feedback hier eingeben...";

      const btn = document.createElement("button");
      btn.textContent = "Absenden";
      btn.onclick = () => {
        const text = textarea.value.trim();
        if (!text) return;

        speichereFeedback(userInfo.id, text);
        feedbackList.innerHTML += `<div>‚Ä¢ ${text}</div>`;

        fetch(WEBHOOK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            content: `üí¨ Neue R√ºckmeldung zu **${userInfo.display_name || userInfo.username}**:\n> ${text}\nVon: ${user.username}`
          })
        });

        textarea.value = "";
      };

      wrapper.appendChild(feedbackList);
      wrapper.appendChild(textarea);
      wrapper.appendChild(btn);
      parent.appendChild(wrapper);
    }

    function ladeFeedback(id) {
      return JSON.parse(localStorage.getItem("feedbacks-" + id)) || [];
    }

    function speichereFeedback(id, text) {
      const arr = ladeFeedback(id);
      arr.push(text);
      localStorage.setItem("feedbacks-" + id, JSON.stringify(arr));
    }

    ladeMitglieder();
  </script>
</body>
</html>
